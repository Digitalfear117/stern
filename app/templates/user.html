{# templates/user.html #}

{% extends "base.html" %}

{% block content %}
<div class="profile-left">
    <div class="left-top">
        <div class="avatar-box">
            <img src="http://s.{{ config.DOMAIN_NAME }}/a/{{ user.id }}?h=120" alt="">
        </div>
        <h1>
            <a class="flag" href="/rankings/{{ constants.GameMode(mode).alias }}/performance?country={{ user.country|lower }}">
                <img src="/images/flags/{{ user.country|lower }}.gif" alt="{{ user.country|capitalize }}">
            </a>
            <!-- TODO: Username color based on groups -->
            {% if user.names %}
            <div class="username" style="color: #888888" title="Previously known as {{ user.names[-1].name }}">{{ user.name }}</div>
            {% else %}
            <div class="username">{{ user.name }}</div>
            {% endif %}
            <!-- TODO: Title (e.g. Former osu! champion) -->
        </h1>
        <div class="user-badges">
        {% for badge in user.badges %}
            <div class="badge-container">
                <a href="{{ badge.badge_url }}" title="{{ badge.badge_description }}">
                    <img src="{{ badge.badge_icon }}" alt="{{ badge.badge_description }}" loading="lazy">
                </a>
            </div>
        {% endfor %}
        </div>
    </div>
    <div class="left-bottom">
        <!-- TODO: Edit button -->
        <div class="userpage-social">
            {% if user.userpage_location %}
            <div title="Location" class="activity">
                <i class="fa-sharp fa-solid fa-location-dot" style="color: #76777b;"></i>
                <p>{{ user.userpage_location }}</p>
            </div>
            {% endif %}
            {% if user.userpage_interests %}
            <div title="Interests" class="activity">
                <i class="fa-regular fa-heart" style="color: #76777b;"></i>
                <p>{{ user.userpage_interests }}</p>
            </div>
            {% endif %}
            {% if user.userpage_website %}
            <div title="Website" class="activity">
                <i class="fa-solid fa-earth-americas" style="color: #76777b;"></i>
                <a href="{{ user.userpage_website }}">{{ user.userpage_website|domain }}</a>
            </div>
            {% endif %}
            {% if user.userpage_discord %}
            <div title="Discord" class="activity">
                <i class="fa-brands fa-discord" style="color: #76777b;"></i>
                <a href="{{ user.userpage_discord }}">Discord</a>
            </div>
            {% endif %}
            {% if user.userpage_twitter %}
            <div title="Twitter" class="activity">
                <i class="fa-brands fa-twitter" style="color: #76777b;"></i>
                <a href="{{ user.userpage_twitter }}">@{{ user.userpage_twitter|twitter_handle }}</a>
            </div>
            {% endif %}
        </div>
        <div class="userpage-stats">
            <div title="Arrived" class="activity">
                <i class="fa-solid fa-right-to-bracket" style="color: #76777b;"></i>
                <p>{{ user.created_at|timeago }}</p>
            </div>
            <div title="Last Active" class="activity">
                {% if is_online %}
                <i class="fa-solid fa-right-from-bracket" style="color: #c966c9;"></i>
                <p>Online</p>
                {% else %}
                <i class="fa-solid fa-right-from-bracket" style="color: #76777b;"></i>
                <p>{{ user.latest_activity|timeago }}</p>
                {% endif %}
            </div>
            <div title="Total Posts" class="activity">
                <i class="fa-regular fa-pen-to-square" style="color: #76777b;"></i>
                <!-- TODO -->
                <p>0 posts</p>
            </div>
        </div>
        {% if user.playstyle > 0 %}
        <div class="playstyle-container">
        {% set current_playstyle = user.playstyle|playstyle %}
        {% for playstyle in constants.Playstyle %}
            {% if playstyle in current_playstyle and playstyle > 0 %}
            <div class="playstyle {{ playstyle.name|lower }}"></div>
            {% endif %}
        {% endfor %}
        </div>
        {% endif %}
    </div>
    <!-- TODO: Add admin controls -->
    <!-- TODO: Report user -->
</div>
<div class="profile-right">
    {% if user.userpage_about %}
    <div class="userpage">
        {{ user.userpage_about|bbcode|safe }}
    </div>
    {% endif %}
    <div class="gamemode-container">
        <a id="gm-0" class="gamemode-button {{ 'active-mode' if mode == 0 }}" href="?mode=0">osu!</a>
        <a id="gm-1" class="gamemode-button {{ 'active-mode' if mode == 1 }}" href="?mode=1">Taiko</a>
        <a id="gm-2" class="gamemode-button {{ 'active-mode' if mode == 2 }}" href="?mode=2">CatchTheBeat</a>
        <a id="gm-3" class="gamemode-button {{ 'active-mode' if mode == 3 }}" href="?mode=3">osu!mania</a>
    </div>
    <table class="profile-table">
        <tbody>
            <tr>
                <td style="padding: 0;">
                    <table class="profile-tabs">
                        <tbody>
                            <td onclick="expandProfileTab('general', true)">General</td>
                            <td onclick="expandProfileTab('leader', true)">Top Plays</td>
                            <td onclick="expandProfileTab('history', true)">Historical</td>
                            <td onclick="expandProfileTab('beatmaps', true)">Beatmaps</td>
                            <td onclick="expandProfileTab('achievements', true)">Achievements</td>
                        </tbody>
                    </table>
                </td>
            </tr>
            <tr onclick="expandProfileTab('general')">
                <td id="tab-general" class="tab-heading">General</td>
            </tr>
            <td>
                <div id="general" class="tab-content" style="opacity: 1; filter: none; display: none; height: 0px;">
                    <div class="tab-spacing">
                    {% if current_stats and current_stats.playcount > 0 %}
                        <div class="profile-performance">
                            <h2>
                                <strong>
                                    <a href="https://osu.ppy.sh/help/wiki/Performance_Points">Performance</a>:
                                    {{ "{:,}".format(current_stats.pp|round(0)|int) }}pp
                                    {% if current_stats.pp > 0 %}
                                        (#{{ pp_rank }})
                                    {% else %}
                                        (#-)
                                    {% endif %}
                                </strong>
                            </h2>
                            {% if pp_rank_country > 0 %}
                            <a href="/rankings/{{ constants.GameMode(mode).alias }}/performance?country={{ user.country|upper }}">
                                <img src="/images/flags/{{ user.country|lower }}.gif" alt="{{ user.country|upper }}">
                            </a>
                            #{{ pp_rank_country }}
                            {% endif %}
                        </div>
                        <div class="profile-graph">
                            <svg></svg>
                        </div>
                        <div class="profile-recent">
                            <h3 class="profile-stats-header">Recent Activity</h3>
                            {% if activity %}
                            <div id="profile-recent-preview">
                                <table>
                                    <tbody>
                                    {% for item in activity[:4] %}
                                        <tr>
                                            <td style="width: 20%;">{{ item.time|timeago }}</td>
                                            <td>{{ item.activity_text|format_activity(item)|safe }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                                {% if activity|length > 4 %}
                                <a href="#" onclick="expandRecentActivity()">Show me more...</a>
                                {% endif %}
                            </div>
                            {% if activity|length > 4 %}
                            <div id="profile-recent-full" style="display: none;">
                                <table>
                                    <tbody>
                                    {% for item in activity %}
                                        <tr>
                                            <td style="width: 20%;">{{ item.time|timeago }}</td>
                                            <td>{{ item.activity_text|format_activity(item)|safe }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                            {% else %}
                            This user hasn't done anything notable recently!
                            {% endif %}
                        </div>
                        <div class="profile-detailed-stats">
                            <h3 class="profile-stats-header">Detailed Stats</h3>
                            <h4 class="profile-stats-element" title="Ranked Score consists of all your highest passing scores you have achieved. If you beat a score, only the difference between them will be added.">
                                <b>Ranked Score</b>: {{ "{:,}".format(current_stats.rscore) }}
                            </h4>
                            <br>
                            <h4 class="profile-stats-element" title="Accuracy is calculated as a pp-weighted average of every beatmap you have achieved a passing score in, with each difficulty counting separately. Accuracy is calculated based on the hit score value - so a 50 is worth 1/6th of a 300 hit, and a miss is worth nothing.">
                                <b>Hit Accuracy</b>: {{ (current_stats.acc * 100)|round(2) }}%
                            </h4>
                            <br>
                            <h4 class="profile-stats-element" title="Total number of ranked beatmap plays. This includes both passes and fails.">
                                <b>Play Count</b>: {{ "{:,}".format(current_stats.playcount) }}
                            </h4>
                            <br>
                            <h4 class="profile-stats-element" title="Total time spent playing.">
                                <b>Play Time</b>: {{ (current_stats.playtime / 60 / 60)|round(1) }} hours
                            </h4>
                            <br>
                            <h4 class="profile-stats-element" title="Total points scored in all ranked beatmap plays. This includes both passes and fails.">
                                <b>Total Score</b>: {{ "{:,}".format(current_stats.tscore) }}
                            </h4>
                            <br>
                            {% set level = current_stats.tscore|get_level %}
                            {% set max_score = constants.level.NEXT_LEVEL[level+1] %}
                            {% set level_percent = ((current_stats.tscore / max_score) * 100)|round|int %}
                            <h4 class="profile-stats-element" title="Your level is based on your total accumulated score. This includes any ranked score, be it a pass or fail. You will gradually increase your level just by playing osu!">
                                <b>Current Level</b>: {{ level }}
                            </h4>
                            <br>
                            <table class="level-bar">
                                <tbody>
                                    <tr>
                                        <td class="level-bar-percent" style="width: {{ ([level_percent, 100]|sort)[0] * 3 }}px;">{{ level_percent }}%</td>
                                        <td style="background-color: white;"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <br>
                            <h4 class="profile-stats-element" title="Total notes hit.">
                                <b>Total Hits</b>: {{ "{:,}".format(current_stats.total_hits) }}
                            </h4>
                            <br>
                            <h4 class="profile-stats-element" title="Total notes hit.">
                                <b>Maximum Combo</b>: {{ "{:,}".format(current_stats.max_combo) }}
                            </h4>
                            <br>
                            <h4 class="profile-stats-element" title="The total number of times this user's replays have been watched.">
                                <b>Replays Watched by Others</b>: {{ current_stats.replay_views }} times
                            </h4>
                            <br>
                            <h4 class="profile-stats-element"><b>Ranks</b></h4>
                            <table class="profile-ranks">
                                <tbody>
                                    <tr>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/XH.png" height="42" alt="XH"></td>
                                        <td style="width: 50px;">{{ current_stats.xh_count }}</td>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/X.png" height="42" alt="X"></td>
                                        <td style="width: 50px;">{{ current_stats.x_count }}</td>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/SH.png" height="42" alt="SH"></td>
                                        <td style="width: 50px;">{{ current_stats.sh_count }}</td>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/S.png" height="42" alt="S"></td>
                                        <td style="width: 50px;">{{ current_stats.s_count }}</td>
                                    </tr>
                                    <tr>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/A.png" height="42" alt="A"></td>
                                        <td style="width: 50px;">{{ current_stats.a_count }}</td>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/B.png" height="42" alt="B"></td>
                                        <td style="width: 50px;">{{ current_stats.b_count }}</td>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/C.png" height="42" alt="C"></td>
                                        <td style="width: 50px;">{{ current_stats.c_count }}</td>
                                        <td style="width: 42px;"><img loading="lazy" src="/images/grades/D.png" height="50" alt="D"></td>
                                        <td style="width: 50px;">{{ current_stats.d_count }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <h3 class="profile-stats-header">No information recorded</h3>
                        This user has not yet played any ranked maps in {{ constants.GameMode(mode).formatted }}.
                    {% endif %}
                    </div>
                </div>
            </td>
            <tr onclick="expandProfileTab('leader')">
                <td id="tab-leader" class="tab-heading">Top Plays</td>
            </tr>
            <td>
                <div id="leader" class="tab-content" style="opacity: 1; filter: none; display: none; height: 0px;">
                    <div id="top-scores">
                        <h2>Best Performance</h2>
                        <p id="top-scores-loading">Loading...</p>
                    </div>
                    <div id="leader-scores">
                        <h2>First Place Ranks</h2>
                        <p id="leader-scores-loading">Loading...</p>
                    </div>
                </div>
            </td>
            <tr onclick="expandProfileTab('history')">
                <td id="tab-history" class="tab-heading">Historical</td>
            </tr>
            <td>
                <div id="history" class="tab-content" style="opacity: 1; filter: none; display: none; height: 0px;">
                    <div class="play-history">
                        <h2 class="profile-stats-header">Play History</h2>
                        <div class="profile-graph">
                            <!-- TODO -->
                        </div>
                    </div>
                    <div class="most-played">
                        <h2 class="profile-stats-header">Most Played Beatmaps</h2>
                        <div id="plays-container">
                            <p id="plays-loading">Loading...</p>
                        </div>
                    </div>
                    <div class="recent-plays">
                        <h2 class="profile-stats-header">Recent Plays (last 24h)</h2>
                        <div id="recent-container">
                            <p id="recent-loading">Loading...</p>
                        </div>
                    </div>
                    <div class="replays-watched">
                        <h2 class="profile-stats-header">Replays Watched History</h2>
                        <div class="profile-graph">
                            <!-- TODO -->
                        </div>
                    </div>
                </div>
            </td>
            <tr onclick="expandProfileTab('beatmaps')">
                <td id="tab-beatmaps" class="tab-heading">Beatmaps</td>
            </tr>
            <td>
                <div id="beatmaps" class="tab-content" style="opacity: 1; filter: none; display: none; height: 0px;">
                    <div class="favourites">
                        <h2 class="profile-stats-header">Favourite Beatmaps</h2>
                        {% if not user.favourites %}
                            <p style="margin: 5px;">This player has no favourite beatmaps :(</p>
                        {% else %}
                        <div class="profile-beatmaps-container">
                            {% for fav in user.favourites %}
                            <table class="profile-beatmap">
                                <tbody>
                                    <tr>
                                        <td>
                                            <a href="/s/{{ fav.set_id }}" class="profile-beatmap-description">
                                                <b>{{ fav.beatmapset.artist }} - {{ fav.beatmapset.title }}</b>
                                            </a>
                                            <br>
                                            {% if fav.beatmapset.server == 0 %}
                                                <a href="https://osu.ppy.sh/u/{{ fav.beatmapset.creator }}">mapped by {{ fav.beatmapset.creator }}</a>
                                            {% else %}
                                                <a href="/u/{{ set.creator }}">mapped by {{ fav.beatmapset.creator }}</a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <img src="http://s.{{ config.DOMAIN_NAME }}/mt/{{ fav.set_id }}" alt="" loading="lazy">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </td>
            <tr onclick="expandProfileTab('achievements')">
                <td id="tab-achievements" class="tab-heading">Achievements</td>
            </tr>
            <td>
                <div id="achievements" class="tab-content" style="opacity: 1; filter: none; display: none; height: 0px;">
                {% if not achievements %}
                    This user has not achieved anything yet.
                {% else %}
                    <h2 class="profile-achievement-header">Beatmap Packs</h2>
                    <div class="achievement-category">
                        {% for achievement in achievement_categories['beatmap-packs'] %}
                        <div class="achievement">
                            {% if achievement in achievements %}
                            <img
                                src="/images/achievements/{{ achievements[achievement].filename }}"
                                title="Unlocked {{ achievements[achievement].unlocked_at|timeago }}"
                                loading="lazy"
                                alt=""
                            >
                            {% else %}
                            <img src="/images/achievements/unknown.png" alt="" loading="lazy">
                            {% endif %}
                            <br>
                            <b>{{ achievement }}</b>
                        </div>
                        {% endfor %}
                    </div>
                    <h2 class="profile-achievement-header">Skill</h2>
                    <div class="achievement-category">
                        {% for achievement in achievement_categories['skill'] %}
                        <div class="achievement">
                            {% if achievement in achievements %}
                            <img
                                src="/images/achievements/{{ achievements[achievement].filename }}"
                                title="Unlocked {{ achievements[achievement].unlocked_at|timeago }}"
                                loading="lazy"
                                alt=""
                            >
                            {% else %}
                            <img src="/images/achievements/unknown.png" alt="" loading="lazy">
                            {% endif %}
                            <br>
                            <b>{{ achievement }}</b>
                        </div>
                        {% endfor %}
                    </div>
                    <h2 class="profile-achievement-header">Dedication</h2>
                    <div class="achievement-category">
                        {% for achievement in achievement_categories['dedication'] %}
                        <div class="achievement">
                            {% if achievement in achievements %}
                            <img
                                src="/images/achievements/{{ achievements[achievement].filename }}"
                                title="Unlocked {{ achievements[achievement].unlocked_at|timeago }}"
                                loading="lazy"
                                alt=""
                            >
                            {% else %}
                            <img src="/images/achievements/unknown.png" alt="" loading="lazy">
                            {% endif %}
                            <br>
                            <b>{{ achievement }}</b>
                        </div>
                        {% endfor %}
                    </div>
                    <h2 class="profile-achievement-header">Hush-Hush</h2>
                    <div class="achievement-category">
                        {% for achievement in achievement_categories['hush-hush'] %}
                        <div class="achievement">
                            {% if achievement in achievements %}
                            <img
                                src="/images/achievements/{{ achievements[achievement].filename }}"
                                title="Unlocked {{ achievements[achievement].unlocked_at|timeago }}"
                                loading="lazy"
                                alt=""
                            >
                            {% else %}
                            <img src="/images/achievements/unknown.png" alt="" loading="lazy">
                            {% endif %}
                            <br>
                            <b>{{ achievement }}</b>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
                </div>
            </td>
        </tbody>
    </table>
</div>
<script>
    const userId = {{ user.id }};
    const mode = {{ mode }};
    const modeName = '{{ constants.GameMode(mode).alias }}';
</script>
<script src="/js/user.js"></script>
{% endblock content %}